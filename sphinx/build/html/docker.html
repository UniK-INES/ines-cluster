

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Docker &mdash; RPi Cluster 0.1 alpha documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Administration" href="admin.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> RPi Cluster
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="technical_overview.html">Technical Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="userguide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="admin.html">Administration</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Docker</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#docker-on-sd-cards">Docker on sd cards</a></li>
<li class="toctree-l2"><a class="reference internal" href="#docker-via-vfs">Docker via vfs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#changing-the-way-we-boot">Changing the way we boot</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">RPi Cluster</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Docker</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/docker.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="docker">
<h1>Docker<a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h1>
<p>In the near future we would like to run docker on the Raspberry Pi nodes. Even though this is generally possible with Raspbian and there are even operating systems like HyperiotOS specializing on running docker containers, we face several problems when it comes to the cluster. For example the nodes’ root partition is mounted over an nfs filesystem lacking copy on write which docker absolutely requires. Another problem is the limited main memory available on the nodes since the operating system is kept exclusively in the RAM.</p>
<p>We identified three different options so far that could work on the cluster. This page intends to keep track of the progress.</p>
<p>General todo list:</p>
<ul class="simple">
<li>Take one node x as test node</li>
</ul>
<ol class="arabic simple">
<li>Make sure no node is running</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>nmap -sP <span class="m">10</span>.42.0.0/24
<span class="c1"># ..</span>
/home/client/python powerall.py off <span class="m">1</span> <span class="m">60</span>
</pre></div>
</div>
<ul class="simple">
<li>Give x its own boot partition on sevastopol (tftp configuration)</li>
</ul>
<ol class="arabic simple">
<li>Backup dnsmasq.conf</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo cp /etc/dnsmasq.conf /etc/dnsmasq.conf.20201202
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Activate individual tftp-root directories based on ip address</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano -w /etc/dnsmasq.conf
<span class="c1"># Add</span>
tftp-unique-root<span class="o">=</span>ip
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Prepare directory and clone boot partition</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo mkdir /pxe/boot/10.42.0.2
sudo rsync -arv --exclude<span class="o">=</span><span class="m">10</span>.42.0.2 /pxe/boot/ /pxe/boot/10.42.0.2/
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Prepare directory and clone root partition</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo mkdir /pxe/root_node02
sudo rsync -arv /pxe/root/ /pxe/root_node02/
<span class="c1"># This will take some time</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Edit cmdline.txt so node02 will boot a different root partition</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano -w /pxe/boot/10.42.0.2/cmdline.txt
<span class="c1"># Change 10.42.0.250:/pxe/root to 10.42.0.250:/pxe/root_node02</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li>Boot node02 and touch a file</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python /home/pi/client/powerall.py on <span class="m">2</span> <span class="m">2</span>
ssh pi@10.42.0.2
touch test_file_node02
<span class="nb">exit</span>
ls /pxe/root_node02 <span class="p">|</span> grep test_file_node02
<span class="c1"># If the file exists booting from the new root partition was successful</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There were some problems when this method was tested for the first time. The node was only be able to boot after several attempts. Maybe todo in the future if problems remain.</p>
</div>
<p>Alternatively the boot directories can also be provided based on the mac address. For that modify steps 2. and 3.</p>
<ol class="arabic simple">
<li>Get mac address for node02</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat /pxe/meta/mac_nodes <span class="p">|</span> grep -oP <span class="s1">&#39;^2[^0-9].*$&#39;</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>In /etc/dnsmasq.conf add an individual directory for the boot partition for node02 (<cite>&lt;https://stackoverflow.com/questions/40008276/dnsmasq-different-tftp-root-for-each-macaddress&gt;_</cite>)</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/dnsmasq.conf</span>
tftp-unique-root<span class="o">=</span>mac
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Get mac address for node02</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat /pxe/meta/mac_nodes <span class="p">|</span> grep -oP <span class="s1">&#39;^2[^0-9].*$&#39;</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Create the directory with lowercase letters and zero padded digits.</li>
</ol>
<ul class="simple">
<li>Include the boot partition in /etc/fstab</li>
</ul>
<ol class="arabic simple">
<li>Connect to node02</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh pi@10.42.0.2
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Change the /etc/fstab on node02</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano -w /etc/fstab
<span class="c1"># Add 10.42.0.250:/pxe/boot/10.42.0.2 /boot nfs defaults,vers=3 0 0</span>
sudo mount -a
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Verify</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ls /boot
<span class="c1"># Should list the contents of /pxe/boot/10.42.0.2 on sevastopol</span>
</pre></div>
</div>
<ul class="simple">
<li>Update/Upgrade the root partition for x (dirty)</li>
</ul>
<ol class="arabic simple">
<li>Backup the root partition</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># On Sevastopol</span>
sudo /bin/bash
mkdir /pxe/root_node02_backup
rsync -avr /pxe/root_node02/ /pxe/root_node02_backup/
<span class="c1"># This will take some time</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Flush all iptables rules</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Add all accepting rules</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allow established connections</span>
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

<span class="c1"># Masquerade</span>
iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Connect to node02 and update/upgrade</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh pi@10.42.0.2
sudo /bin/bash
apt-get update
apt-get full-upgrade --dry-run &gt; ~/full_upgrade_list
apt-get full-upgrade <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> tee ~/full_upgrade
</pre></div>
</div>
<div class="section" id="docker-on-sd-cards">
<h2>Docker on sd cards<a class="headerlink" href="#docker-on-sd-cards" title="Permalink to this headline">¶</a></h2>
<p>In later docker versions it is possible to keep the docker root on a different storage. Every node has an unused sd card that could be used to store the docker containers.</p>
<p>What needs to be done:</p>
<ol class="arabic simple">
<li>Script that mounts the sd cards on nodes (ssh)</li>
<li>Install docker</li>
<li>If apt-get does not work, compiling it with gcc (binaries can be used for every single node later on)</li>
<li>Change docker configuration so the container root is on the sd card</li>
<li>Start container</li>
<li>If failure, try to move everything related to docker (binary, configuration, etc) to sd card</li>
<li>If success, compress every step into bash script so it can be done automatically on other nodes</li>
</ol>
</div>
<div class="section" id="docker-via-vfs">
<h2>Docker via vfs<a class="headerlink" href="#docker-via-vfs" title="Permalink to this headline">¶</a></h2>
<p>VFS as an overlay file system could be used to provide the COW functionality.</p>
<p>What needs to be done:</p>
<ol class="arabic simple">
<li>Install VFS on x</li>
<li>Find out path where docker saves containers</li>
<li>Put the overlay over path</li>
<li>Trials</li>
<li>If failure, add overlay for everything docker related</li>
<li>If success, automate via bash script</li>
</ol>
</div>
<div class="section" id="changing-the-way-we-boot">
<h2>Changing the way we boot<a class="headerlink" href="#changing-the-way-we-boot" title="Permalink to this headline">¶</a></h2>
<p>The nodes can also be booted with a standard Raspbian OS stored to the local sd cards.</p>
<p>What needs to be done:</p>
<ol class="arabic simple">
<li>Information on how to install os remotely (ssh)</li>
<li>Identify the essential manufactorer’s scripts for powering on the nodes (should be 3 on sevastopol)</li>
<li>Build an image including everything</li>
<li>Scripts for deploying on every node</li>
<li>Single out second test node y</li>
<li>Trials</li>
<li>Automate process so os can be rolled out to every single node</li>
<li>Changes to nfs server</li>
<li>Additional ssh scripts for controlling the cluster (zero scripts as base)</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="admin.html" class="btn btn-neutral float-left" title="Administration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Christoph Hanauer, Sascha Holzhauer.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>